---
name: Does the therapist elicit a past/future discrepancy?
slug: past-future-discrepancy
triggers: none  # no specific triggers, evaluated when transition requires it
model: clever_and_expensive
return:
  type: ForcedChoiceResponse
  options:
    response:
      commentary: str
      yes:
        label: "Yes, eliciting a discrepancy between current and future states."
        actions: [other-slug-for-an-action, or-multiple-actions]
      no: 
        label: "No, not eliciting a discrepancy between current and future states."
      partial:
        label: 'The task is only partially complete.'
  required:
        - commentary
        - response
  hints:
    commentary: "Think carefully. Give a short explanation of your rationale."
    response: "Only answer 'yes' if you are confident in your classification."
---


# Context

You are: {{system.personas.supervisor}}
{{system.concepts.FIT}}


# Overview

A therapist in your team is working with {{meta.client_name|default:"a client"}} 
to help them with {{meta.client_problem|default:""}}.  

You have access to a transcript of their recent session. You need to provide 
feedback to the therapist about whether they adhere to the principles of functional
imagery training.


# Relevant clinical notes

These are previous notes made by the therapist which may be relevant:

{{ notes | hyde : "client talk about discrepancy between current and future state" }}


# Previous judgements you made on this task

<!-- include formatted versions of the previous judgement -->
{{ notes.by_key previous }}


# Recent conversations

<!--  include all utterances from the current step 
      we could include more but limit it to ensure that the disrepancy 
      has been elicited recently -->
{% turns step=current, smalltalk=false %}


# Specific task

We need to check that the therapist has elicited a discrepancy between
current and future states to build motivation (important in FIT).

Only respond "yes" if:

- the client has expressed uncertainty or ambivalence about their current state
- the client has imagined and voiced a future state which is improved
- the therapist has reflected these, and highlighted the discrepancy


# Detailed thinking and rationale

Think about the problem step by step. 
Use quotes from the conversation to support your decision.

<!-- at this point the model responds free-form 
      to enhance the quality of the context for the final classification -->

[[THINKING]]


# Your response

<!-- 
  At this point we extract structured data from the model.

  The json section below is generted automatically from the `return_value` key
  in the yaml front matter and drives the model response using tool-calling/magentic.
  It's equivalent to this Pydantic model, so we can use magentic to force the model
  to return structured data:

  class ForcedChoiceResponse(BaseModel):
    commentary: str = Field(
        ...,
        description="Think carefully about your classification and give a 1 paragraph explanation of your rationale here.",
    )
    response: Literal["yes", "no", "maybe"] = Field(
        ..., description="Only answer 'yes' if you are confident in your classification."
    )
    class Config:
        json_schema_extra = {
            "hint": "This model is used for classification responses where the user must justify their decision."
        }

  print(json.dumps(schema_dict, indent=2))
  print(yaml.dump(schema_dict, default_flow_style=False))
  
-->


{
  "properties": {
    "commentary": {
      "description": "Think carefully about your classification and give a short, 1-paragraph explanation of your rationale here.",
      "title": "Commentary",
      "type": "string"
    },
    "response": {
      "enum": [
        "yes",
        "no",
        "partially"
      ],
      "title": "Response",
      "type": "string"
    }
  },
  "required": [
    "commentary",
    "response"
  ],
  "title": "Response",
  "type": "object"
}

